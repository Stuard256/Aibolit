{% extends 'base.html' %}

{% block content %}
<h2>{% if appointment %}Редактирование приёма{% else %}Новый приём{% endif %}</h2>

<form method="POST">

    <input type="hidden" id="selected_date" name="selected_date">
    <input type="hidden" id="selected_time" name="selected_time">
    <!-- Дата и время приёма -->
    <div class="mb-3">
        <label for="date" class="form-label">Дата</label>
        <input type="date" class="form-control" id="date" name="date" value="{{ appointment.appointment_date if appointment else '' }}" required>
    </div>
    <div class="mb-3">
        <label for="time" class="form-label">Время</label>
        <input type="time" class="form-control" id="time" name="time" value="{{ appointment.time if appointment else '' }}" required>
    </div>

    <!-- Описание приёма -->
    <div class="mb-3">
        <label for="description" class="form-label">Описание</label>
        <textarea class="form-control" id="description" name="description" rows="3" required>{{ appointment.description if appointment else '' }}</textarea>
    </div>

    <!-- Выбор владельца и животного -->
    <div class="mb-3">
        <label for="owner" class="form-label">Владелец</label>
        <select class="form-control" id="owner" name="owner" required onchange="updatePets()">
            <option value="" disabled {% if not appointment %}selected{% endif %}>Выберите владельца</option>
            {% for owner in owners %}
            <option value="{{ owner.id }}" {% if appointment and owner.id == appointment.owner_id %}selected{% endif %}>{{ owner.name }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="mb-3">
        <label for="pet" class="form-label">Животное</label>
        <select class="form-control" id="pet" name="pet" required>
            <option value="" disabled {% if not appointment %}selected{% endif %}>Выберите животное</option>
            {% for pet in pets %}
            <option value="{{ pet.id }}" {% if appointment and pet.id == appointment.pet_id %}selected{% endif %} class="pet-option owner-{{ pet.owner_id }}">{{ pet.name }}</option>
            {% endfor %}
        </select>
    </div>

    <!-- Продолжительность приёма (по умолчанию 30 минут) -->
    <div class="mb-3">
        <label for="duration" class="form-label">Продолжительность (мин)</label>
        <input type="number" class="form-control" id="duration" name="duration" value="{{ appointment.duration if appointment else 30 }}" required>
    </div>

    <!-- Выбор повторного приёма -->
    <div class="mb-3">
        <label for="recurring" class="form-label">Повторный приём</label>
        <select class="form-control" id="recurring" name="recurring">
            <option value="none" {% if not appointment or not appointment.is_recurring %}selected{% endif %}>Не повторять</option>
            <option value="10_days" {% if appointment and appointment.recurring_type == '10_days' %}selected{% endif %}>Через 10 дней</option>
            <option value="21_days" {% if appointment and appointment.recurring_type == '21_days' %}selected{% endif %}>Через 21 день</option>
            <option value="1_year" {% if appointment and appointment.recurring_type == '1_year' %}selected{% endif %}>Через год</option>
            <option value="1_year_birthday" {% if appointment and appointment.recurring_type == '1_year_birthday' %}selected{% endif %}>Когда исполнилось 1 год</option>
            <option value="custom_date" {% if appointment and appointment.recurring_type == 'custom_date' %}selected{% endif %}>Выбрать дату</option>
        </select>
    </div>

    <!-- Поле для выбора конкретной даты, если выбран вариант с кастомной датой -->
    <div class="mb-3" id="custom_date_field" style="display: {% if appointment and appointment.recurring_type == 'custom_date' %}block{% else %}none{% endif %};">
        <label for="custom_date" class="form-label">Выберите дату повторного приёма</label>
        <input type="date" class="form-control" id="custom_date" name="custom_date" value="{{ appointment.appointment_date if appointment and appointment.recurring_type == 'custom_date' else '' }}">
    </div>

    <button type="submit" class="btn btn-success">Записать</button>
</form>


<script>

    function updatePets() {
        let ownerId = document.getElementById('owner').value;
        fetch(`/api/pets?owner_id=${ownerId}`)
            .then(response => response.json())
            .then(data => {
                let petSelect = document.getElementById('pet');
                petSelect.innerHTML = "";
                data.forEach(pet => {
                    let option = document.createElement('option');
                    option.value = pet.id;
                    option.textContent = pet.name;
                    petSelect.appendChild(option);
                });
            });
    }

    document.getElementById('recurring').addEventListener('change', function() {
        if (this.value === 'custom_date') {
            document.getElementById('custom_date_field').style.display = 'block';
        } else {
            document.getElementById('custom_date_field').style.display = 'none';
        }
    });

    // Функция для получения параметров из URL
    function getUrlParams() {
        const urlParams = new URLSearchParams(window.location.search);
        return {
            date: urlParams.get('date'),
            time: urlParams.get('time')
        };
    }

    // Функция для автозаполнения формы данными из URL
    function fillFormFromUrlParams() {
        const params = getUrlParams();
        if (params.date) {
            document.getElementById('date').value = params.date;  // Заполняем поле даты
        }
        if (params.time) {
            document.getElementById('time').value = params.time;  // Заполняем поле времени
        }
    }

    // Заполняем форму при загрузке страницы
    window.onload = function() {
        fillFormFromUrlParams();
    };
</script>


{% endblock %}
