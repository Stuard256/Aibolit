{% extends "base.html" %}
{% block title %}Карточка животного{% endblock %}
{% block content %}
<div class="container-fluid">
  <div class="row">
    <!-- Левая колонка - форма редактирования -->
    <div class="col-md-6">
      <h2>Карточка животного</h2>
      <form method="post">
        <div class="mb-3">
          <label for="name" class="form-label">Кличка</label>
          <input type="text" class="form-control" name="name" id="name" value="{{ pet.name }}" required>
        </div>
        <div class="mb-3">
          <label for="card_number" class="form-label">Номер карточки</label>
          <input type="text" class="form-control" name="card_number" id="card_number" value="{{ pet.card_number }}"
            required>
        </div>
        <div class="mb-3">
          <label for="species" class="form-label">Вид животного</label>
          <input list="species_list" class="form-control" name="species" id="species" value="{{ pet.species }}"
            required>
          <datalist id="species_list">
            <option value="собака">
            <option value="кот">
            <option value="кролик">
            <option value="хорёк">
            <option value="крыса">
          </datalist>
        </div>
        <div class="mb-3">
          <label for="gender" class="form-label">Пол</label>
          <select name="gender" id="gender" class="form-select" required>
            <option value="М" {% if pet.gender=="М" %}selected{% endif %}>М</option>
            <option value="Ж" {% if pet.gender=="Ж" %}selected{% endif %}>Ж</option>
            <option value="кастрат М" {% if pet.gender=="кастрат М" %}selected{% endif %}>кастрат М</option>
            <option value="кастрат Ж" {% if pet.gender=="кастрат Ж" %}selected{% endif %}>кастрат Ж</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="breed" class="form-label">Порода</label>
          <input type="text" class="form-control" name="breed" id="breed" value="{{ pet.breed }}" required>
        </div>
        <div class="mb-3">
          <label for="coloration" class="form-label">Окрас</label>
          <input type="text" class="form-control" name="coloration" id="coloration" value="{{ pet.coloration }}">
        </div>
        <div class="mb-3">
          <label for="birth_date" class="form-label">Дата рождения (ДД-MM-ГГГГ)</label>
          <input type="text" class="form-control" name="birth_date" id="birth_date"
            value="{{ pet.birth_date.strftime('%d-%m-%Y') }}" required>
        </div>
        <div class="mb-3">
          <label for="chronic_diseases" class="form-label">Хронические заболевания</label>
          <textarea class="form-control" name="chronic_diseases"
            id="chronic_diseases">{{ pet.chronic_diseases }}</textarea>
        </div>
        <div class="mb-3">
          <label for="allergies" class="form-label">Аллергии</label>
          <textarea class="form-control" name="allergies" id="allergies">{{ pet.allergies }}</textarea>
        </div>
        <div class="mb-3">
          <a href="{{ url_for('print_pet_card', pet_id=pet.id) }}" class="btn btn-secondary" target="_blank">
            <i class="bi bi-printer"></i> Распечатать PDF
          </a>
        </div>
        <button type="submit" class="btn btn-primary">Сохранить изменения</button>

      </form>
      <div class="mt-4 border-top pt-3">
        <form method="POST" action="{{ url_for('delete_pet', pet_id=pet.id) }}" onsubmit="return confirmDelete()"
          class="d-inline">
          <button type="submit" class="btn btn-danger">
            <i class="bi bi-trash"></i> Удалить карточку
          </button>
        </form>
        <a href="{{ url_for('new_vaccination', pet_id=pet.id, owner_id=owner.id) }}" class="btn btn-success ms-2">
          <i class="bi bi-plus-circle"></i> Добавить вакцинацию
        </a>
      </div>
      <p class="mt-3"><strong>Владелец:</strong> <a href="{{ url_for('owner_card', owner_id=owner.id) }}">{{ owner.name
          }}</a></p>
    </div>

    <!-- Правая колонка - список вакцинаций -->
    <div class="col-md-6">
      <h2>Вакцинации</h2>
      {% if pet.vaccinations %}
      <div class="table-responsive">
        <table class="table table-striped">
          <thead>
            <tr>
              <th>Дата</th>
              <th>Тип</th>
              <th>Название</th>
              <th>Действия</th>
            </tr>
          </thead>
          <tbody>
            {% for vaccination in pet.vaccinations|sort(attribute='date_administered', reverse=True) %}
            <tr>
              <td>{{ vaccination.date_administered.strftime('%d.%m.%Y') }}</td>
              <td>{{ vaccination.vaccination_type }}</td>
              <td>{{ vaccination.vaccine_name }}</td>
              <td>
                <a href="{{ url_for('edit_vaccination', id=vaccination.id) }}" class="btn btn-sm btn-outline-primary">
                  <i class="bi bi-pencil"></i>
                </a>
                <form method="POST" action="{{ url_for('delete_vaccination', id=vaccination.id) }}" class="d-inline">
                  <button type="submit" class="btn btn-sm btn-outline-danger"
                    onclick="return confirm('Удалить эту вакцинацию?')">
                    <i class="bi bi-trash"></i>
                  </button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="alert alert-info">Нет данных о вакцинациях</div>
      {% endif %}
    </div>
    <h2 class="mt-4">Записи на приём</h2>
    {% if pet.appointments %}
    <div class="table-responsive">
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Дата</th>
            <th>Время</th>
            <th>Описание</th>
            <th>Назначения</th>
            <th>Действия</th>
          </tr>
        </thead>
        <tbody>
          {% for appointment in pet.appointments|sort(attribute='appointment_date', reverse=True) %}
          <tr>
            <td>{{ appointment.appointment_date }}</td>
            <td>{{ appointment.time }}</td>
            <td>
              {% if appointment.description|length > 30 %}
              {{ appointment.description[:30] }}...
              {% else %}
              {{ appointment.description }}
              {% endif %}
            </td>
            <td>
              {% if appointment.treatments %}
              <span class="badge bg-primary">{{ appointment.treatments|length }}</span>
              {% else %}
              <span class="badge bg-secondary">0</span>
              {% endif %}
            </td>
            <td>
              <a href="{{ url_for('appointment_details', appointment_id=appointment.id) }}"
                class="btn btn-sm btn-outline-primary" title="Подробнее">
                <i class="bi bi-eye"></i>
              </a>
              <a href="{{ url_for('treatment_calculator', appointment_id=appointment.id, pet_id=pet.id) }}"
                class="btn btn-sm btn-outline-success ms-1" title="Назначения">
                <i class="bi bi-prescription"></i>
              </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="alert alert-info">Нет записей на приём</div>
    {% endif %}

    <!-- Кнопка для создания новой записи -->
    <div class="mt-3">
      <a href="{{ url_for('new_appointment', pet_id=pet.id, owner_id=owner.id) }}" class="btn btn-success">
        <i class="bi bi-plus-circle"></i> Новая запись
      </a>
    </div>
  </div>
</div>

<script>
  function confirmDelete() {
    return confirm('Вы уверены, что хотите удалить карточку животного? Это действие нельзя отменить!');
  }
</script>
{% endblock %}